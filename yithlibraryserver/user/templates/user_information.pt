<!DOCTYPE html>
<html lang="en"
      xmlns:tal="http://xml.zope.org/namespaces/tal"
      xmlns:metal="http://xml.zope.org/namespaces/metal"
      metal:use-macro="profile.macros['profile']">

<tal:block metal:fill-slot="header-title">User information</tal:block>

<tal:block metal:fill-slot="profile-content">

  <div class="row-fluid">

    <div class="span6">
      <h2>Personal information</h2>
      <form tal:replace="structure form">form</form>
    </div>

    <div class="span6" tal:condition="request.user.email">
      <div tal:condition="not request.user.email_verified">
        <h2>Email verification needed!</h2>
        <p>Your email is not verified so you can not link
          your different accounts.</p>
        <a id="open-email-verification-dialog" href="#email-verification-dialog" class="btn btn-primary" data-toggle="modal">Verify your email address</a>
      </div>
    </div>

  </div>

  <div class="row-fluid">

    <div class="span6" tal:condition="request.user.email">
      <div tal:condition="not request.user.email_verified">
        <p>Your email is not verified so you can not link
          your different accounts.</p>
        <a id="open-email-verification-dialog" href="#email-verification-dialog" class="btn btn-primary" data-toggle="modal">Verify your email address</a>
      </div>
      <div tal:condition="request.user.email_verified">
        <h4>Identity providers</h4>
        <p>You are registered with the following accounts:</p>
        <ul class="unstyled">
          <li tal:repeat="account accounts">
            <div tal:omit-tag="" tal:repeat="provider account['providers']">
              <img tal:attributes="class 'current provider' if provider['is_current'] else 'provider'"
                   src="${request.static_path('yithlibraryserver:static/img/' + provider['name'] + '-mini-logo.png')}"
                   alt="${provider['name']}"
                   width="32"
                   height="32" />
            </div>
            <span class="badge" title="${account['passwords']} passwords" tal:content="account['passwords']">Number of passwords</span>
            <span class="badge badge-inverse" tal:condition="account['is_current']">Current</span>
          </li>
        </ul>
        <div tal:condition="has_several_accounts">
          <div class="alert alert-info">
            <button type="button" class="close" data-dismiss="alert">×</button>
            <h4>Account merging is possible!</h4>
            If you merge your accounts you will be able to access your passwords in a unified way: no matter which provider you use to log in you will always see the same set of passwords.</div>
          <a class="btn btn-primary" href='${request.route_path("user_merge_accounts")}'>Merge my accounts ...</a>
        </div>
      </div>
    </div>
  </div>

  <div class="modal hide" id="email-verification-dialog">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal">×</button>
      <h3>Email verification</h3>
    </div>
    <div class="modal-body">
      <p>An email with a verification link will be sent to
        <strong>${request.user.email}</strong> to verify that you are
        its legitimate owner.</p>
      <p>All you need to do is click on the <i>Send verification email</i>
        button, go to your inbox and follow the instructions in the email.</p>
      <div class="alert alert-info hide">
        <p>The email message with the verification link has been sent. <strong>Go and check your inbox!</strong></p>
      </div>
      <div class="alert alert-error hide">
        <p>There was an error sending the verification link to your email address. <strong></strong></p>
      </div>
    </div>
    <div class="modal-footer">
      <a href="#" class="btn" data-dismiss="modal">Cancel</a>
      <a id="send-verification-email" href="#" class="btn btn-primary">Send verification email</a>
    </div>
  </div>

</tal:block>

<tal:block metal:fill-slot="extra-scripts">
  <script type="text/javascript">
    (function ($) {
      "use strict";
      $(document).ready(function () {
        $("#send-verification-email").click(function () {
          var $button = $(this);
          if ($button.hasClass("disabled")) {
            return;
          }
          $button.addClass("disabled");
          $.ajax({
            type: 'POST',
            url: '${request.route_path("user_send_email_verification_code")}',
            data: {submit: 'Send verification code'},
            dataType: 'json',
            success: function (data, textStatus, jqXHR) {
              if (data.status === 'ok') {
                $("#email-verification-dialog .alert-info").removeClass("hide");
                $("#open-email-verification-dialog").addClass("hide");
              } else {
                $("#email-verification-dialog .alert-error").removeClass("hide").find("strong").text(data.error);
                $("#email-verification-dialog .alert-info").addClass("hide");
                $button.removeClass("disabled");
              }
            }
          });
        });
      });
    })(jQuery);
  </script>
</tal:block>

</html>
